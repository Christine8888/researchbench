{
    "task_id": "photoz_flow_metrics_at_z1",
    "kind": "numeric",
    "difficulty": 7,
    "description": "Implement a normalizing flow for photometric redshift estimation on CosmoDC2 data and evaluate its performance metrics at redshift z = 1",
    "instructions": "In this task, you'll implement a normalizing flow-based photometric redshift estimator following the approach in 'Probabilistic Forward Modeling of Galaxy Catalogs with Normalizing Flows' by Crenshaw et al. (2024):\n\n1. Data Preparation:\n   - Download a subset of the CosmoDC2 catalog containing galaxy redshifts and ugrizy magnitudes\n   - Select galaxies with at most one band beyond the LSST 10-year 5-sigma point source depths\n   - Split the data into 80% training and 20% test sets\n   - Convert the magnitude data to colors using a Color Transform: (redshift, u, g, r, i, z, y) → (redshift, i, u-g, g-r, r-i, i-z, z-y)\n\n2. Normalizing Flow Implementation:\n   - Implement a Rational-Quadratic Rolling Spline Coupling (RQ-RSC) flow with 7 dimensions\n   - Use a uniform latent distribution over the range [-5, 5]\n   - Set up the flow architecture as: RQ-RSC ∘ Shift Bounds ∘ Color Transform\n   - Configure the RQ-RSC with 16 spline knots\n   - Use a coupling function with a feedforward neural network (two hidden layers of 128 neurons)\n\n3. Training:\n   - Train for 150 epochs using the Adam optimizer\n   - Use an initial learning rate of 10^-3, decreased by a factor of 10 every 50 epochs\n   - Implement photometric error convolution during training\n\n4. Evaluation:\n   - For each galaxy in the test set, compute the photo-z posterior\n   - Calculate the point estimate by finding the mode of each posterior\n   - Select galaxies with true redshifts in the bin centered at z = 1.0 (e.g., z between 0.95 and 1.05)\n   - Compute three metrics for these galaxies:\n     a. Bias: median of Δz = (z_photo - z_true)/(1 + z_true)\n     b. Scatter: NMAD = 1.4826 × median(|Δz - median(Δz)|)\n     c. Outlier fraction: percentage of galaxies with |Δz| > 3 × scatter\n   - Return these three values as a comma-separated list of floating-point numbers: \"bias,scatter,outlier_fraction\"\n\nNote: This task reproduces the metrics shown in Figure 10 of the paper specifically for the redshift bin at z = 1.0.",
    "expected_output": [-0.00,0.017,0.04],
    "tolerance": [0.005,0.005,0.005],
    "parents": [],
    "output_justification": "These expected output values come directly from Figure 10 in the paper, which shows the bias, scatter, and outlier fraction of photo-z point estimates as a function of true galaxy redshift. For the bin centered at z = 1.0, the figure shows a bias of approximately -0.01, a scatter of approximately 0.02, and an outlier fraction of approximately 0.015 (1.5%). These are verifiable numerical results presented in the paper's photo-z metrics section."
  }